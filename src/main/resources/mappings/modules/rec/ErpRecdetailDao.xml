<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.rec.dao.ErpRecdetailDao">
    
	<sql id="erpRecdetailColumns">
		a.id AS "id",
		a.recid AS "recid",
		c.item_desc AS "item",
		c.id AS "itemdr",
		a.uom AS "uom",
		a.qty AS "qty",
		a.sp AS "sp",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.remarks AS "remarks",
		a.del_flag AS "delFlag"
	</sql>
	
	<sql id="erpRecdetailJoins">
		LEFT JOIN erp_rec b ON b.id = a.recid
		LEFT JOIN erp_item c ON  c.id= a.item_dr
	</sql>
	
	
	<select id="get" resultType="ErpRecdetail">
		SELECT 
			<include refid="erpRecdetailColumns"/>
		FROM erp_recdetail a
		<include refid="erpRecdetailJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findListNew" resultType="ErpRecdetail">
		SELECT 
			<include refid="erpRecdetailColumns"/>
		FROM erp_recdetail a
		<include refid="erpRecdetailJoins"/>
		<where>
			a.recid = #{recid} and a.del_flag='0'
			<!-- and a.del_flag = #{DEL_FLAG_NORMAL} -->
		</where>
		<choose>
			<!-- <when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when> -->
			<otherwise>
				ORDER BY a.create_date ASC
			</otherwise>
		</choose>
	</select>
	
	<!-- 
                 根据班级id查询班级信息(带老师的信息)
         ##1. 联表查询(非懒加载的实现)
         SELECT * FROM class c,teacher t WHERE c.teacher_id=t.t_id AND c.c_id=1;
         
         ##2. 执行两次查询(懒加载的实现)
         SELECT * FROM class WHERE c_id=1;  //teacher_id=1
         SELECT * FROM teacher WHERE t_id=1;//使用上面得到的teacher_id
 
                 方式一：(非懒加载的实现)
                                     嵌套结果：使用嵌套结果映射来处理重复的联合结果的子集
                                     封装联表查询的数据(去除重复的数据)
             select * from class c, teacher t where c.teacher_id=t.t_id and c.c_id=1
     -->
	<!-- 使用resultMap映射实体类和字段之间的一一对应关系 -->
	<select id="findErpRecdetailListByRecId"  resultMap="ErpRecdetailResultMap">
	     select recdetail.*,
	            item.id as pid,
	            item.item_no as itemNo,
	            item.item_desc as itemDesc,
	            item.item_sp as itemSp,
	            item.item_spec as itemSpec,
	            uom.id as uid,
	            uom.erp_uomCode as erpUomcode,
	            uom.erp_uomDesc as erpUomdesc
	      from  erp_recdetail recdetail, 
	            erp_item item,
	            erp_uom uom
	      where recdetail.item_dr=item.id
	        and item.item_uom=uom.erp_uomCode
	        and recdetail.recid=#{id}
	        and recdetail.del_flag='0'
	</select>
	
	<select id="findErpRecdetailListByRecIdnew"  resultType="com.thinkgem.jeesite.modules.rec.entity.ErpRecdetailNew">
select recdetail.id,
	            recdetail.recid as recid,
	            recdetail.subid as subid,
	            item_dr as itemid,
	            item.item_no as itemno,
	            item.item_desc as itemdesc,
	            item.item_spec as itemspec,
	            uom.id as uomid,
	            uom.erp_uomCode as uomcode,
	            uom.erp_uomDesc as uomdesc,
	            recdetail.qty as qty,
	            recdetail.sp as sp,
	            recdetail.sp_amt as spamt,
	            recdetail.rp as rp,
	            recdetail.rp_amt as rpamt,
	            recdetail.recdep_dr as depid,
	            manf.id as manfid,
	            manf.manf_desc as manfdesc,
	            recdetail.batno as batno,
	            recdetail.expdate as expdate,
	            recdetail.itemlb_dr as itemlbdr,
	            recdetail.itemib_dr as itemibdr,
	            recdetail.invno as invno,
	            recdetail.invno_amt as invamt,
	            recdetail.inv_date as invdate,
	            recdetail.margin as margin
	      from  erp_recdetail recdetail, 
	            erp_item item,
	            erp_uom uom,
	            erp_manf manf
	      where recdetail.item_dr=item.id
	        and item.item_uom=uom.erp_uomCode
	        and recdetail.recid=#{id}
	        and recdetail.manf_dr=manf.id
	        and recdetail.del_flag='0'
	</select>
	
	<resultMap type="com.thinkgem.jeesite.modules.item.entity.ErpItem" id="ErpItemResultMap">
		<id property="id" column="pid" />
		<result property="itemNo" column="itemNo" />
		<result property="itemDesc" column="itemDesc" />
		<result property="itemSpec" column="itemSpec" />
		<result property="itemSp" column="itemSp" />
		
		<!-- property对应一对多查询中实体类对应的属性，javaType此属性对应的实体类 -->
		<association property="erpUom" javaType="com.thinkgem.jeesite.modules.erpuom.entity.ErpUom">
		    <!-- property对应实体类中的属性名称  column对应sql语句中的字段名称(即xml中select中的字段名称，如果有as别名 则为as之后的别名)，
		       可以有别名，如果无别名则对应表结构定义中的字段名称 -->
			<id property="id" column="uid" />
			<result property="erpUomcode" column="erpUomcode" />
			<result property="erpUomdesc" column="erpUomdesc" />
		</association>
	</resultMap>
	
	<resultMap type="com.thinkgem.jeesite.modules.rec.entity.ErpRecdetail" id="ErpRecdetailResultMap">
		<id property="id" column="id" />
		<result property="uom" column="uom" />
		<result property="qty" column="qty" />
		<result property="sp" column="sp" />
		<!-- 把入库明细实体映射从association元素中提取出来，用一个resultMap元素表示。然后association元素再引用这个resultMap元素 -->
        <association property="item" resultMap="ErpItemResultMap"/> 
		
		<!-- property对应一对多查询中实体类对应的属性，javaType此属性对应的实体类--> 
		<!--<association property="item" javaType="com.thinkgem.jeesite.modules.item.entity.ErpItem">
		    property对应实体类中的属性名称  column对应sql语句中的字段名称，可以有别名，如果无别名则对应表结构定义中的字段名称
			<id property="id" column="pid" />
			<result property="itemNo" column="item_no" />
			<result property="itemDesc" column="item_desc" />
			<result property="erpUom" column="item_uom" />
			<result property="itemSpec" column="item_spec" />
			<result property="itemSp" column="item_sp" />
			
		</association> -->
	</resultMap>

	
	
	<select id="findAllList" resultType="ErpRecdetail">
		SELECT 
			<include refid="erpRecdetailColumns"/>
		FROM erp_recdetail a
		<include refid="erpRecdetailJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date ASC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert" parameterType="com.thinkgem.jeesite.modules.rec.entity.ErpRecdetail">
		INSERT INTO erp_recdetail(
			id,
			recid,
			item_dr,
			uom,
			qty,
			sp,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{recid},
			#{item.id},
			#{uom},
			#{qty},
			#{sp},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>
	
	
	<update id="update">
		UPDATE erp_recdetail SET 	
			recid = #{recid},
			item_dr = #{item.id},
			uom = #{uom},
			qty = #{qty},
			sp = #{sp},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			remarks = #{remarks}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE erp_recdetail SET 
			del_flag = #{DEL_FLAG_DELETE}
		<choose>
			<when test="id !=null and id != ''">
				WHERE id = #{id}
			</when>
			<otherwise>
				WHERE recid = #{recid}
			</otherwise>
		</choose>
	</update>
	
	
	<!-- EasyUI版本 -->
	<insert id="insertE" parameterType="com.thinkgem.jeesite.modules.rec.entity.ErpRecdetailNew">
		INSERT INTO erp_recdetail(
			id,
			recid,
			subid,
			item_dr,
			uom_dr,
			qty,
			sp,
			sp_amt,
			rp,
			rp_amt,
			recdep_dr,
			manf_dr,
			batno,
			expdate,
			itemlb_dr,
			invno,
			inv_date,
			invno_amt,
			margin,
			itemib_dr,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
			
		) VALUES (
			#{id}
			#{recid},
			#{subid},
			#{itemid},
			#{uomid},
			#{qty},
			#{sp},
			#{spamt},
			#{rp},
			#{rpamt},
			#{recdep_dr},
			#{manfid},
			#{batno}
			#{expdate},
			#{itemlbdr},
			#{invno},
			#{invdate},
			#{invamt},
			#{margin},
			#{itemibdr},
			#{create_by},
			#{create_date},
			#{update_by},
			#{update_date},
			#{remarks},
			#{del_flag}
		)
	</insert>
</mapper>